id: plex_webhook_handler_beta
blueprint:
  name: Plex Webhook Handler BETA (v0.5.1)
  homeassistant:
    min_version: "2024.6.0"
  description: "Plex webhook events are handled by this blueprint.<br></br>A Plex Client name is needed for Movie, Music, and TV Show actions.<br>For webhook details, see the [Home Assistant website](https://www.home-assistant.io/docs/automation/trigger#webhook-trigger).<br>Need help with Plex and webhooks? [Click here](https://support.plex.tv/articles/115002267687-webhooks/).<br><br>**Requirements:**<br>- The **Sun** integration must be enabled if you plan to use 'Use Sunset/Sunrise' filters."
  domain: automation
  source_url: https://github.com/thenextbutton/home_assistant/blob/main/blueprints/plex_webhook_handler/plex_webhook_beta.yaml

  input:
    webhook_id:
      name: Webhook ID
      description: "Configure your Plex Media Server webhook to send notifications to: http://{your-home-assistant}:8123/api/webhook/{webhook_id}"
      selector:
        text:
          multiline: false
          multiple: false
      default: ""
    webhook_local_only:
      name: Webhook Local Only
      description: "Enable to only accept webhook requests from your local network."
      selector:
        boolean: {}
      default: true

    plex_player_details:
      name: Player Details
      icon: mdi:plex
      collapsed: false
      input:
        plex_client_uuid:
          name: Plex Client UUID
          selector:
            text:
              multiple: true
          default: ""
        plex_client:
          name: Plex Client Name
          selector:
            text:
              multiple: true
          default: ""
        plex_client_retrieve:
          name: Plex Client Name/UUID ?
          selector:
            boolean: {}
          default: false

    movie_time_settings:
      name: "Movie Time Constraints"
      icon: mdi:clock-check
      collapsed: true
      input:
        movie_time_filter_enabled:
          name: Enable Time Constraints
          default: false
          selector:
            boolean: {}
        movie_use_sun:
          name: Use Sunset/Sunrise
          default: false
          selector:
            boolean: {}
        movie_start_time:
          name: Start Time
          default: "00:00:00"
          selector:
            time: {}
        movie_end_time:
          name: End Time
          default: "23:59:59"
          selector:
            time: {}

    movie_actions:
      name: Movie Actions
      icon: mdi:movie
      collapsed: true
      input:
        movie_play_actions:
          name: Movie Play Actions
          selector:
            action: {}
          default: []
        movie_resume_mimics_play:
          name: Movie Resume Mimics Play Actions
          selector:
            boolean: {}
          default: false
        movie_resume_actions:
          name: Movie Resume Actions
          selector:
            action: {}
          default: []
        movie_pause_actions:
          name: Movie Pause Actions
          selector:
            action: {}
          default: []
        movie_stop_actions:
          name: Movie Stop Actions
          selector:
            action: {}
          default: []
        movie_scrobble_actions:
          name: Movie Scrobble Actions
          selector:
            action: {}
          default: []

    track_time_settings:
      name: "Music Time Constraints"
      icon: mdi:clock-check
      collapsed: true
      input:
        track_time_filter_enabled:
          name: Enable Time Constraints
          default: false
          selector:
            boolean: {}
        track_use_sun:
          name: Use Sunset/Sunrise
          default: false
          selector:
            boolean: {}
        track_start_time:
          name: Start Time
          default: "00:00:00"
          selector:
            time: {}
        track_end_time:
          name: End Time
          default: "23:59:59"
          selector:
            time: {}

    music_actions:
      name: Music Actions
      icon: mdi:music
      collapsed: true
      input:
        track_play_actions:
          name: Music Play Actions
          selector:
            action: {}
          default: []
        track_resume_mimics_play:
          name: Music Resume Mimics Play Actions
          selector:
            boolean: {}
          default: false
        track_resume_actions:
          name: Music Resume Actions
          selector:
            action: {}
          default: []
        track_pause_actions:
          name: Music Pause Action
          selector:
            action: {}
          default: []
        track_stop_actions:
          name: Music Stop Actions
          selector:
            action: {}
          default: []
        track_scrobble_actions:
          name: Music Scrobble Actions
          selector:
            action: {}
          default: []

    television_time_settings:
      name: "TV Show Time Constraints"
      icon: mdi:clock-check
      collapsed: true
      input:
        episode_time_filter_enabled:
          name: Enable Time Constraints
          default: false
          selector:
            boolean: {}
        episode_use_sun:
          name: Use Sunset/Sunrise
          default: false
          selector:
            boolean: {}
        episode_start_time:
          name: Start Time
          default: "00:00:00"
          selector:
            time: {}
        episode_end_time:
          name: End Time
          default: "23:59:59"
          selector:
            time: {}

    television_actions:
      name: TV Show Actions
      icon: mdi:television
      collapsed: true
      input:
        episode_play_actions:
          name: TV Show Play Actions
          selector:
            action: {}
          default: []
        episode_resume_mimics_play:
          name: TV Show Resume Mimics Play Actions
          selector:
            boolean: {}
          default: false
        episode_resume_actions:
          name: TV Show Resume Actions
          selector:
            action: {}
          default: []
        episode_pause_actions:
          name: TV Show Pause Actions
          selector:
            action: {}
          default: []
        episode_stop_actions:
          name: TV Show Stop Actions
          selector:
            action: {}
          default: []
        episode_scrobble_actions:
          name: TV Show Scrobble Actions
          selector:
            action: {}
          default: []

    media_rated_actions:
      name: Media Rated Actions
      icon: mdi:star-half-full
      collapsed: true
      input:
        movie_rated_actions:
          name: Movie Rated Actions
          selector:
            action: {}
          default: []
        movie_collection_rated_actions:
          name: Movie Collection Rated Actions
          selector:
            action: {}
          default: []
        album_rated_actions:
          name: Music Album Rated Actions
          selector:
            action: {}
          default: []
        album_artist_rated_actions:
          name: Music Artist Rated Actions
          selector:
            action: {}
          default: []
        track_artist_rated_actions:
          name: Music Track Rated Actions
          selector:
            action: {}
          default: []
        season_rated_actions:
          name: TV Season Rated Actions
          selector:
            action: {}
          default: []
        show_rated_actions:
          name: TV Show Rated Actions
          selector:
            action: {}
          default: []

    new_item_actions:
      name: NEW Content Actions
      icon: mdi:alert-decagram
      collapsed: true
      input:
        library_new_movie:
          name: New Library Movie Item(s)
          selector:
            action: {}
          default: []
        library_new_music_album:
          name: New Library Music Item(s)
          selector:
            action: {}
          default: []
        library_new_music_artist:
          name: New Library Music Artist
          selector:
            action: {}
          default: []
        library_new_tv_show:
          name: New Library TV Show Item(s)
          selector:
            action: {}
          default: []
        library_new_tv_episode:
          name: New Library TV episode Item(s)
          selector:
            action: {}
          default: []

    generic_playback_action:
      name: Generic Playback Actions
      icon: mdi:play-circle
      collapsed: true
      input:
        generic_playback_started:
          name: Playback Started
          selector:
            action: {}
          default: []
        generic_resume_mimics_play:
          name: Playback Resume mimics playback.
          selector:
            boolean: {}
          default: false
        generic_playback_resume:
          name: Playback Resume
          selector:
            action: {}
          default: []
        generic_playback_pause:
          name: Playback Pause
          selector:
            action: {}
          default: []
        generic_playback_stopped:
          name: Playback Stopped
          selector:
            action: {}
          default: []

    server_actions:
      name: Server Owner Actions
      icon: mdi:database-cog
      collapsed: true
      input:
        admin_database_backup_actions:
          name: Admin Database Backup Actions
          selector:
            action: {}
          default:
            - service: persistent_notification.create
              data:
                message: Plex Database Backup completed for {{ payload.Server.title }}
                notification_id: plex_db_backup
                title: Plex Alert
        admin_database_corruption_actions:
          name: Admin Database Corruption Actions
          selector:
            action: {}
          default:
            - service: persistent_notification.create
              data:
                message: Plex Database CORRUPTION Detected for {{ payload.Server.title }}
                notification_id: plex_db_corruption
                title: "!! Plex Alert !!"
        admin_device_new:
          name: Admin New Device
          selector:
            action: {}
          default:
            - service: persistent_notification.create
              data:
                title: "New Plex Client Connection:"
                message: "{{ payload.Player.title }}"
        admin_playback_started:
          name: Admin Playback Started
          selector:
            action: {}
          default:
            - service: persistent_notification.create
              data:
                title: "{{ payload.Account.title }} -  Playback started"
                notification_id: "plex_user_playback_{{ payload.Account.title }}"
                message: "  {{ payload.Account.title }} has started playback on {{ payload.Player.title }}"

    automation_actions:
      name: Automation Actions
      icon: mdi:cog
      collapsed: true
      input:
        automation_mode:
          name: Automation Mode
          selector:
            select:
              options:
                - label: Single
                  value: single
                - label: Restart (Default)
                  value: restart
                - label: Queued
                  value: queued
                - label: Parallel
                  value: parallel
          default: restart
        trace_count:
          name: Trace Count
          selector:
            number:
              min: 1
              max: 20
          default: 5

mode: !input automation_mode
trace:
  stored_traces: !input trace_count

triggers:
  - trigger: webhook
    allowed_methods:
      - POST
      - PUT
    local_only: !input webhook_local_only
    webhook_id: !input webhook_id

action:
  - variables:
      sun_exists: "{{ states('sun.sun') not in ['unknown', 'unavailable', None] }}"
      payload: "{{ trigger.data['payload'].decode('utf-8') | from_json }}"
      player_title: "{{ payload.Player.title if 'Player' in payload else None }}"
      player_uuid: "{{ payload.Player.uuid if 'Player' in payload else None }}"
      plex_client_retrieve: !input plex_client_retrieve
      plex_client: !input plex_client
      plex_client_uuid: !input plex_client_uuid
      movie_time_enabled: !input movie_time_filter_enabled
      movie_sun_enabled: !input movie_use_sun
      movie_start_time: !input movie_start_time
      movie_end_time: !input movie_end_time
      track_time_enabled: !input track_time_filter_enabled
      track_sun_enabled: !input track_use_sun
      track_start_time: !input track_start_time
      track_end_time: !input track_end_time
      episode_time_enabled: !input episode_time_filter_enabled
      episode_sun_enabled: !input episode_use_sun
      episode_start_time: !input episode_start_time
      episode_end_time: !input episode_end_time
      movie_resume_mimics_play: !input movie_resume_mimics_play
      track_resume_mimics_play: !input track_resume_mimics_play
      episode_resume_mimics_play: !input episode_resume_mimics_play
      generic_resume_mimics_play: !input generic_resume_mimics_play

  - if:
      - condition: template
        value_template: "{{ plex_client_retrieve == true }}"
    then:
      - action: persistent_notification.create
        data:
          title: "Plex Client Name/UUID:"
          message: |
            Name: {{ payload.Player.title if 'Player' in payload else 'Not Found!' }}
            UUID: {{ payload.Player.uuid if 'Player' in payload else 'Not Found!' }}

  - if:
      - condition: template
        value_template: "{{ payload.event in ['media.play', 'media.resume', 'media.pause', 'media.stop'] }}"
    then:
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ payload.event == 'media.play' or ( payload.event == 'media.resume' and generic_resume_mimics_play) }}"
            sequence: !input generic_playback_started
          - conditions:
              - condition: template
                value_template: "{{ payload.event == 'media.pause' }}"
            sequence: !input generic_playback_pause
          - conditions:
              - condition: template
                value_template: "{{ payload.event == 'media.resume' and not generic_resume_mimics_play }}"
            sequence: !input generic_playback_resume
          - conditions:
              - condition: template
                value_template: "{{ payload.event == 'media.stop' }}"
            sequence: !input generic_playback_stopped

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ payload.event == 'admin.database.backup' }}"
        sequence: !input admin_database_backup_actions
      - conditions:
          - condition: template
            value_template: "{{ payload.event == 'admin.database.corrupted' }}"
        sequence: !input admin_database_corruption_actions
      - conditions:
          - condition: template
            value_template: "{{ payload.event == 'device.new' }}"
        sequence: !input admin_device_new
      - conditions:
          - condition: template
            value_template: "{{ payload.event == 'playback.started' }}"
        sequence: !input admin_playback_started
      - conditions:
          - condition: template
            value_template: "{{ payload.event == 'library.new' }}"
        sequence:
          - choose:
              - conditions: "{{ payload.Metadata.type == 'movie' }}"
                sequence: !input library_new_movie
              - conditions: "{{ payload.Metadata.type == 'album' }}"
                sequence: !input library_new_music_album
              - conditions: "{{ payload.Metadata.type == 'artist' }}"
                sequence: !input library_new_music_artist
              - conditions: "{{ payload.Metadata.type == 'show' }}"
                sequence: !input library_new_tv_show
              - conditions: "{{ payload.Metadata.type == 'episode' }}"
                sequence: !input library_new_tv_episode
      - conditions:
          - condition: template
            value_template: "{{ payload.event == 'media.rate' }}"
        sequence:
          - choose:
              - conditions: "{{ payload.Metadata.type == 'movie' }}"
                sequence: !input movie_rated_actions
              - conditions: "{{ payload.Metadata.type == 'track' }}"
                sequence: !input track_artist_rated_actions
              - conditions: "{{ payload.Metadata.type == 'episode' }}"
                sequence: !input show_rated_actions

      - conditions:
          - condition: template
            value_template: >
              {{ (player_uuid | default('')).lower().strip() in (plex_client_uuid | map('lower') | map('trim') | list) or
              (player_title | default('')).lower().strip() in (plex_client | map('lower') | map('trim') | list) }}
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ payload.Metadata.type == 'movie' }}"
                sequence:
                  - if:
                      - condition: or
                        conditions:
                          - condition: template
                            value_template: "{{ not movie_time_enabled }}"
                          - condition: and
                            conditions:
                              - condition: template
                                value_template: "{{ movie_sun_enabled and sun_exists }}"
                              - condition: state
                                entity_id: sun.sun
                                state: "below_horizon"
                          - condition: and
                            conditions:
                              - condition: template
                                value_template: "{{ not movie_sun_enabled }}"
                              - condition: template
                                value_template: >
                                  {% set n = now().strftime('%H:%M:%S') %}
                                  {% if movie_start_time <= movie_end_time %}
                                    {{ n >= movie_start_time and n <= movie_end_time }}
                                  {% else %}
                                    {{ n >= movie_start_time or n <= movie_end_time }}
                                  {% endif %}
                    then:
                      - choose:
                          - conditions: "{{ payload.event == 'media.play' or (payload.event == 'media.resume' and movie_resume_mimics_play) }}"
                            sequence: !input movie_play_actions
                          - conditions: "{{ payload.event == 'media.resume' and not movie_resume_mimics_play }}"
                            sequence: !input movie_resume_actions
                          - conditions: "{{ payload.event == 'media.pause' }}"
                            sequence: !input movie_pause_actions
                          - conditions: "{{ payload.event == 'media.stop' }}"
                            sequence: !input movie_stop_actions
                          - conditions: "{{ payload.event == 'media.scrobble' }}"
                            sequence: !input movie_scrobble_actions

              - conditions:
                  - condition: template
                    value_template: "{{ payload.Metadata.type == 'track' }}"
                sequence:
                  - if:
                      - condition: or
                        conditions:
                          - condition: template
                            value_template: "{{ not track_time_enabled }}"
                          - condition: and
                            conditions:
                              - condition: template
                                value_template: "{{ track_sun_enabled and sun_exists }}"
                              - condition: state
                                entity_id: sun.sun
                                state: "below_horizon"
                          - condition: and
                            conditions:
                              - condition: template
                                value_template: "{{ not track_sun_enabled }}"
                              - condition: template
                                value_template: >
                                  {% set n = now().strftime('%H:%M:%S') %}
                                  {% if track_start_time <= track_end_time %}
                                    {{ n >= track_start_time and n <= track_end_time }}
                                  {% else %}
                                    {{ n >= track_start_time or n <= track_end_time }}
                                  {% endif %}
                    then:
                      - choose:
                          - conditions: "{{ payload.event == 'media.play' or (payload.event == 'media.resume' and track_resume_mimics_play) }}"
                            sequence: !input track_play_actions
                          - conditions: "{{ payload.event == 'media.resume' and not track_resume_mimics_play }}"
                            sequence: !input track_resume_actions
                          - conditions: "{{ payload.event == 'media.pause' }}"
                            sequence: !input track_pause_actions
                          - conditions: "{{ payload.event == 'media.stop' }}"
                            sequence: !input track_stop_actions
                          - conditions: "{{ payload.event == 'media.scrobble' }}"
                            sequence: !input track_scrobble_actions

              - conditions:
                  - condition: template
                    value_template: "{{ payload.Metadata.type == 'episode' }}"
                sequence:
                  - if:
                      - condition: or
                        conditions:
                          - condition: template
                            value_template: "{{ not episode_time_enabled }}"
                          - condition: and
                            conditions:
                              - condition: template
                                value_template: "{{ episode_sun_enabled and sun_exists }}"
                              - condition: state
                                entity_id: sun.sun
                                state: "below_horizon"
                          - condition: and
                            conditions:
                              - condition: template
                                value_template: "{{ not episode_sun_enabled }}"
                              - condition: template
                                value_template: >
                                  {% set n = now().strftime('%H:%M:%S') %}
                                  {% if episode_start_time <= episode_end_time %}
                                    {{ n >= episode_start_time and n <= episode_end_time }}
                                  {% else %}
                                    {{ n >= episode_start_time or n <= episode_end_time }}
                                  {% endif %}
                    then:
                      - choose:
                          - conditions: "{{ payload.event == 'media.play' or (payload.event == 'media.resume' and episode_resume_mimics_play) }}"
                            sequence: !input episode_play_actions
                          - conditions: "{{ payload.event == 'media.resume' and not episode_resume_mimics_play }}"
                            sequence: !input episode_resume_actions
                          - conditions: "{{ payload.event == 'media.pause' }}"
                            sequence: !input episode_pause_actions
                          - conditions: "{{ payload.event == 'media.stop' }}"
                            sequence: !input episode_stop_actions
                          - conditions: "{{ payload.event == 'media.scrobble' }}"
                            sequence: !input episode_scrobble_actions
